---
title: "Price Elasticity Analysis"
date: "12/06/2021"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    css: styles-default.css
    logo: logo.png
runtime: shiny
---

```{r setup, include=FALSE}
#Shiny
library(flexdashboard)
library(shiny)
library(shinyWidgets)
library(DT)

#Core
library(tidyverse)
library(ggplot2)
library(plotly)
library(infer)
library(readxl)
```

```{r}
#sourcing my code
source("../R/cleaning_data.R")

#importing data
descriptions_path <- "../data/raw_data_cereal_descriptions.xlsx"
prices_path <- "../data/raw_data_cereal_prices.xlsx"

descriptions_tbl <- readRDS(file = "descriptions_tbl.rds")
prices_tbl <- readRDS(file = "prices_tbl.rds")
```

```{r, include = FALSE}
source("../R/cleaning_data.R")

#obtaining our data tables
top_three_brands_tbl <- readRDS(file = "top_three_brands_tbl.rds")
```

```{r, include = FALSE}
source("../R/cleaned_data.R")

#obtaining our data tables
sales_tbl <- readRDS(file = "sales_tbl.rds")
sales_sample_tbl <- readRDS(file = "sales_sample_tbl.rds")
```

```{r, include = FALSE}
#source code to plot the boxplot
source("../R/plot_boxplot.R")
```

```{r, include = FALSE}
#source code to plot the violin plot
source("../R/plot_violin.R")
```

```{r, include = FALSE}
#source code to plot the histogram
source("../R/plot_histogram.R")
```

```{r, include = FALSE}
#source code to plot the scatter plot
source("../R/plot_scatter.R")
```

```{r, include = FALSE}
#source code to plot the fitted vs residual
source("../R/plot_fitted_vs_residual.R")
```

```{r, include = FALSE}
#source code to plot the bootstrap
source("../R/plot_bootstrap.R")
```

```{r, include = FALSE}
#source code to obtain a bootstrap and CI
source("../R/get_bootstrap_and_ci.R")

bootstrap_tbl <- readRDS(file = "bootstrap_tbl.rds")
ci <- readRDS(file = "ci.rds")
```


Page 1
==============================================

### About Elasticity


Page 2
==============================================

Sidebar {.sidebar}
----------------------------------------------

``` {r}
#Inputs
checkboxGroupButtons(inputId = "Cereal_brand",
                   label = h4("Select Cereal Brands:"),
                   choices = c("Wheaties", "Cinnamon Toast Crunch", "Kix"),
                   selected = c("Wheaties", "Cinnamon Toast Crunch", "Kix"),
                   direction = "vertical")

```

```{r}
# Reset Button
actionButton(inputId = "reset",
             label = "Reset",
             icon = icon("sync"))

observeEvent(eventExpr = input$reset, handlerExpr = {
  
  updateCheckboxGroupButtons(session = session,
                           inputId = "Cereal_brand",
                           selected = c("Wheaties", "Cinnamon Toast Crunch", "Kix"))
})
```

Column {data-width = 500}
----------------------------------------------

### Data Overview

<!-- - Add Pie charts and stuff -->


Page 3
==============================================

Sidebar {.sidebar}
----------------------------------------------

``` {r}
#Inputs
checkboxGroupButtons(inputId = "Cereal_brand",
                   label = h4("Select Cereal Brands:"),
                   choices = c("Wheaties", "Cinnamon Toast Crunch", "Kix"),
                   selected = c("Wheaties", "Cinnamon Toast Crunch", "Kix"),
                   direction = "vertical")

sliderInput(inputId = "alpha",
            label = h4("Select Alpha:"),
            min = 0.80,
            max = 0.95,
            value = 0.95,
            step = 0.05,
            pre = "%")
```

```{r}
# Reset Button
actionButton(inputId = "reset",
             label = "Reset",
             icon = icon("sync"))

observeEvent(eventExpr = input$reset, handlerExpr = {
  
  updateCheckboxGroupButtons(session = session,
                           inputId = "Cereal_brand",
                           selected = c("Wheaties", "Cinnamon Toast Crunch", "Kix"))
  
  updateSliderInput(session = session,
                    inputId = "alpha",
                    value = .95)
})
```

Column {data-width = 500}
----------------------------------------------

### Elasticity Analysis

```{r}
# Reactive Filter - Description
dataset <- reactive({
  sales_sample_tbl %>%
    filter(description %in% input$Cereal_brand)
})
```

```{r}
# Reactive Filter - Alpha Level
reactive_alpha <- reactive({
  new_ci_tbl <- bootstrap_tbl %>%
    group_by(term) %>%
    nest() %>%
    mutate(perc_ci = map(
      data,
      get_confidence_interval,
      level = input$alpha,
      type = "percentile"
    )) %>%
    unnest(perc_ci)
})

```

```{r} 
# Scatter Plot
# renderTable(dataset())
plotlyOutput("scatter_plot")

output$scatter_plot <- renderPlotly({
  data = dataset()
  plot_scatter(data)
})
```

```{r}
# Bootstrap plot
# renderTable(reactive_alpha())
plotlyOutput("bootstrap_plot")

output$bootstrap_plot <- renderPlotly({
  data = reactive_alpha()
  plot_bootstrap(data)
})
```



